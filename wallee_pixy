#define enA 9
#define enB 10
#define in1 6
#define in2 7
#define in3 4
#define in4 5
#define TRIGGER_PIN  12
#define ECHO_PIN     11
#define MAX_DISTANCE 400
 

#include <NewPing.h>
#include <Pixy2.h>

// This is the main Pixy object 
Pixy2 pixy;
NewPing sonar(TRIGGER_PIN, ECHO_PIN, MAX_DISTANCE);

int i, j, area;


void setup() {
  pinMode(enA, OUTPUT);
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
 
  Serial.begin(115200);
  Serial.print("...Starting...\n");
  pixy.init();
  pixy.setLamp(0, 0);
  delay(500);

}
void loop() {
  
  int pwmOutput = 255; // value from 0 to 255
  analogWrite(enA, pwmOutput); // Send PWM signal to L298N Enable pin
  analogWrite(enB, pwmOutput);
  pixy.ccc.getBlocks();
  /*Serial.print("Ping: ");
  Serial.print(sonar.ping_cm());
  Serial.println("cm");
*/

if (pixy.ccc.numBlocks)
  {
    pwmOutput = 255;
    Serial.print("Detected ");
    Serial.println(pixy.ccc.numBlocks);
    for (i=0; i<pixy.ccc.numBlocks; i++)
    {
      area = (pixy.ccc.blocks[i].m_width * pixy.ccc.blocks[i].m_height);
      Serial.print("  block ");
      Serial.print(i);
      Serial.print(": ");
      pixy.ccc.blocks[i].print();
      Serial.print("  Area: ");
      Serial.print(area); Serial.print("\n");
          
      if(pixy.ccc.blocks[i].m_x<=100)
      {      
      lft();  
      delay(20); 
      }   

      if(pixy.ccc.blocks[i].m_x>=220)
      {      
      rght();      
      delay(20); 
      }
            
      if(pixy.ccc.blocks[i].m_x>100 && pixy.ccc.blocks[i].m_x<220)
      {      
      fwd();
      delay(200);
      }
      
      
      if(pixy.ccc.blocks[i].m_x>100 && pixy.ccc.blocks[i].m_x<220 && area>2500)
      {
      bck();
      }

      stp(); 
      delay (5);

                            
    }
  }  

    else {
     
      pwmOutput=150;
      search(); delay(300);
    }

}

void fwd()
{
  Serial.print("\nforward\n");
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
}

void bck()
{
  Serial.print("\nback\n");
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}

void lft()
{
  Serial.print("\nleft\n");
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH); 
}

void rght()
{
  Serial.print("\nright\n");
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
}

void stp()
{
  Serial.print("\nhalt!\n");
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
}

void search()
{
  Serial.print("\nSESRCHING\n");
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
}
